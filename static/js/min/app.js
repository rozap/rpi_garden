require.config({baseUrl:"/static/js/",shim:{underscore:{exports:"_"},backbone:{deps:["underscore","jquery"],exports:"Backbone"},d3:{exports:"d3"},rickshaw:{deps:["d3"],exports:"rickshaw"}},paths:{jquery:"libs/jquery",underscore:"libs/underscore",backbone:"libs/backbone",d3:"libs/d3",rickshaw:"libs/rickshaw"}}),require(["underscore","backbone","d3","rickshaw","collections","models","text!templates/chart.html","text!templates/state.html"],function(e,t,i,n,a,s,r,o){var l={dispatcher:e.clone(t.Events)};setInterval(function(){l.dispatcher.trigger("fetchNewData")},12e4);var h=t.View.extend({width:800,height:400,template:e.template(r),events:{"click .next-btn":"nextPage","click .prev-btn":"prevPage"},initialize:function(){this.collection=new this.series([],l),this.listenTo(this.collection,"sync",this.render),this.collection.fetch()},adaptData:function(){var e=this;return[{color:e.color,name:e.yName,data:this.collection.map(function(t){return{x:t.get(e.xName),y:t.get(e.yName)}})}]},render:function(){this.$el.html(this.template({id:this.$el.attr("id"),title:this.title,hasNext:this.collection.hasNext.bind(this.collection),hasPrev:this.collection.hasPrev.bind(this.collection)})),console.log($(this.$el.attr("id")+"-chart")[0]);this._graph=new n.Graph({element:$("#"+this.$el.attr("id")+"-chart")[0],renderer:"area",min:this.minY,max:this.maxY,series:this.adaptData()}),new Rickshaw.Graph.Axis.Time({graph:this._graph});var e={graph:this._graph,orientation:"left",width:80,tickFormat:Rickshaw.Fixtures.Number.formatKMBT,element:$("#"+this.$el.attr("id")+"chart-y-axis")[0]};new Rickshaw.Graph.Axis.Y(e);new Rickshaw.Graph.HoverDetail({graph:this._graph,xFormatter:this.formatX.bind(this),yFormatter:this.formatY.bind(this)});this._graph.render()},formatX:function(e){return new Date(1e3*e)+" "+(this.xUnits||this.xName)},formatY:function(e){return e+" "+(this.yUnits||this.yName)},nextPage:function(){this.collection.next()},prevPage:function(){this.collection.prev()}}),c=h.extend({title:"ph",el:"#ph-view",xName:"time",yName:"ph",series:a.PHCollection,color:"#A9C388",minY:5.8,maxY:8}),m=h.extend({title:"Temperature",el:"#temp-view",xName:"time",yName:"temp",yUnits:"degrees",series:a.TempCollection,color:"#F54551",minY:73,maxY:78}),d=h.extend({title:"Water level",el:"#level-view",xName:"time",yName:"level",yUnits:"inches",series:a.LevelCollection,color:"#015A61",minY:20,maxY:29}),p=t.View.extend({el:"#state-view",template:e.template(o),initialize:function(){this.model=new s.State({},l),this.listenTo(this.model,"sync",this.render),this.model.fetch(),this._interval=setInterval(this.model.fetch.bind(this.model),3e3)},render:function(){return this.$el.html(this.template({model:this.model.toJSON()})),this}}),u=t.View.extend({el:"#timelapse",images:[],events:{"click .run-timelapse":"run"},run:function(){clearInterval(this._interval),this.images=[],console.log("RUNNING"),this.load(0),this.off("loadedBatch"),this.on("loadedBatch",this.play.bind(this))},play:function(){console.log("PLAY");var e=this.$el.find("canvas")[0],t=e.getContext("2d"),i=0;this._interval=setInterval(function(){if(!this.images[i])return void this.stop();var e=this.images[i];t.drawImage(e,0,0,e.naturalWidth,e.naturalHeight),i++}.bind(this),20)},stop:function(){clearInterval(this._interval)},load:function(e){this.loadBatch(e,function(t,i,n){this.images=this.images.concat(t),console.log("Done loading batch"),this.trigger("loadedBatch",e),i||this.load(e+n)}.bind(this))},loadBatch:function(t,i){for(var n=40,a=!1,s=[],r=e.after(n,function(){s=s.sort(function(e){return e[0]}).map(function(e){return e[1]}),i(s,a,n)}),o=t;t+n>o;o++){var l=new Image;l.i=o,l.onload=function(){s.push([this.i,this]),r()}.bind(l),l.onerror=function(){a=!0,r()},l.src="/static/timelapse/"+o+"-image.jpg"}}});new c,new m,new d,new p,new u,console.info("hello world")});